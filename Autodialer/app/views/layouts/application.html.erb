<!DOCTYPE html>
<html>
  <head>
    <title>Autodialer - Demo Application</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
      .simulation-banner {
        background: linear-gradient(45deg, #ff6b35, #f7931e);
        color: white;
        text-align: center;
        padding: 8px 0;
        font-weight: bold;
        border-bottom: 2px solid #e55722;
      }
      
      .sidebar {
        min-height: calc(100vh - 56px);
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
      }
      
      .main-content {
        padding: 20px;
      }
      
      .stat-card {
        border-left: 4px solid #007bff;
        transition: transform 0.2s;
      }
      
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      
      .status-badge {
        font-size: 0.8em;
        padding: 0.25em 0.5em;
      }
      
      .ai-command-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .call-log-row {
        transition: background-color 0.2s;
      }
      
      .call-log-row:hover {
        background-color: #f8f9fa;
      }
      
      .phone-number-display {
        font-family: 'Courier New', monospace;
        font-weight: bold;
      }
      
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .ai-response {
        background-color: #e8f4f8;
        border-left: 4px solid #17a2b8;
        padding: 15px;
        margin-top: 10px;
        border-radius: 0 5px 5px 0;
      }
      
      .voice-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      
      .record-btn {
        background: #dc3545;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .record-btn.recording {
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
      }
    </style>
  </head>

  <body>
    <!-- Simulation Mode Banner -->
    <% if @simulation_mode %>
      <div class="simulation-banner">
        <i class="bi bi-shield-exclamation"></i>
        <strong>SIMULATION MODE</strong> - No real phone calls are being made. This is a demonstration only.
      </div>
    <% end %>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <%= link_to root_path, class: "navbar-brand" do %>
          <i class="bi bi-telephone-fill me-2"></i>
          Autodialer Demo
        <% end %>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <%= link_to "Dashboard", dashboard_path, class: "nav-link #{'active' if current_page?(dashboard_path)}" %>
            </li>
            <li class="nav-item">
              <%= link_to "Phone Numbers", phone_numbers_path, class: "nav-link #{'active' if controller_name == 'phone_numbers'}" %>
            </li>
            <li class="nav-item">
              <%= link_to "Call Logs", call_logs_path, class: "nav-link #{'active' if controller_name == 'call_logs'}" %>
            </li>
          </ul>
          
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> Settings
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal">
                  <i class="bi bi-sliders"></i> System Settings
                </a></li>
                <li><a class="dropdown-item" href="/health" target="_blank">
                  <i class="bi bi-heart-pulse"></i> Health Check
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-muted" href="#">
                  <i class="bi bi-info-circle"></i> Version 1.0.0
                </a></li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Flash Messages -->
    <% if notice || alert || flash[:success] || flash[:error] || flash[:warning] %>
      <div class="container-fluid mt-2">
        <% if notice || flash[:success] %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i>
            <%= notice || flash[:success] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% end %>
        
        <% if alert || flash[:error] %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i>
            <%= alert || flash[:error] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% end %>
        
        <% if flash[:warning] %>
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-circle"></i>
            <%= flash[:warning] %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Main Content -->
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
          <div class="p-3">
            <h6 class="text-muted mb-3">QUICK ACTIONS</h6>
            <div class="d-grid gap-2">
              <%= link_to phone_numbers_path, class: "btn btn-outline-primary btn-sm" do %>
                <i class="bi bi-plus-circle"></i> Add Numbers
              <% end %>
              
              <button class="btn btn-outline-success btn-sm" onclick="startAutodialer()">
                <i class="bi bi-play-circle"></i> Start Calling
              </button>
              
              <%= link_to today_call_logs_path, class: "btn btn-outline-info btn-sm" do %>
                <i class="bi bi-clock-history"></i> Today's Logs
              <% end %>
            </div>
            
            <hr>
            
            <h6 class="text-muted mb-3">AI ASSISTANT</h6>
            <div id="ai-status" class="small text-muted mb-2">
              <i class="bi bi-robot"></i> Ready to help
            </div>
          </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-md-10 main-content">
          <%= yield %>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">System Settings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted">Settings are managed through the SystemSetting model for this demo.</p>
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between">
                <span>Simulation Mode</span>
                <span class="badge bg-success">Enabled</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Max Phone Numbers</span>
                <span class="badge bg-info">100</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>Call Delay</span>
                <span class="badge bg-secondary">2 seconds</span>
              </li>
              <li class="list-group-item d-flex justify-content-between">
                <span>AI Voice</span>
                <span class="badge bg-success">Enabled</span>
              </li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
      function startAutodialer() {
        if (confirm('Start calling all pending phone numbers?')) {
          fetch('/ai_commands/process_text_command', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
            },
            body: JSON.stringify({ command: 'start calling all numbers' })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showAlert(data.response, 'success');
            } else {
              showAlert('Failed to start autodialer', 'error');
            }
          });
        }
      }
      
      function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }
      
      // Auto-refresh dashboard every 30 seconds
      if (window.location.pathname === '/dashboard' || window.location.pathname === '/') {
        setInterval(() => {
          if (document.visibilityState === 'visible') {
            window.location.reload();
          }
        }, 30000);
      }
    </script>
  </body>
</html>